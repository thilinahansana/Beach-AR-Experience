<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Beach AR Experience</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/ar.js/1.7.2/aframe/build/aframe-ar.min.js"></script>
    <script src="https://unpkg.com/aframe-gesture-detector@3.3.0/dist/aframe-gesture-detector.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

    <script>
      AFRAME.registerComponent("rotation-reader", {
        schema: { default: 1 },
        init: function () {
          this.el.addEventListener("dragmove", (event) => {
            const rotation = this.el.getAttribute("rotation");
            this.el.setAttribute("rotation", {
              x: rotation.x,
              y: rotation.y + event.detail.deltaX * 0.5,
              z: rotation.z,
            });
          });
        },
      });

      // Generic animation controller that can be used for any model
      AFRAME.registerComponent("model-animation-controller", {
        schema: {
          animationName: { type: "string", default: "" },
          autoPlay: { type: "boolean", default: true },
        },

        init: function () {
          // Store reference to the model entity
          this.modelEntity = this.el;
          this.animationMixer = null;
          this.modelName = this.data.animationName || "model";

          // Wait for model to load before setting up animations
          this.modelEntity.addEventListener("model-loaded", () => {
            console.log(`${this.modelName} model loaded`);

            // Get the animation mixer component
            this.animationMixer =
              this.modelEntity.components["animation-mixer"];

            if (this.animationMixer) {
              console.log(`Animation mixer found for ${this.modelName}!`);

              // Auto-play animation if configured
              if (this.data.autoPlay) {
                setTimeout(() => {
                  this.animationMixer.playAll();
                  console.log(`Auto-playing ${this.modelName} animations`);
                }, 100);
              }

              // List available animations if any
              const mixer = this.animationMixer.mixer;
              if (mixer && mixer._actions && mixer._actions.length > 0) {
                console.log(
                  `${this.modelName} has ${mixer._actions.length} animations`
                );
                mixer._actions.forEach((action, index) => {
                  console.log(`Animation ${index}: ${action._clip.name}`);
                });
              }
            } else {
              console.warn(
                `No animation-mixer found on the ${this.modelName} model`
              );
            }
          });

          // Add click event to toggle animation
          this.el.addEventListener("click", () => {
            if (this.animationMixer) {
              if (this.animationMixer.isPlaying) {
                console.log(`Stopping ${this.modelName} animations`);
                this.animationMixer.stopAll();
              } else {
                console.log(`Playing ${this.modelName} animations`);
                this.animationMixer.playAll();
              }
            }
          });
        },

        // Method to play a specific animation if available
        playAnimation: function (animName) {
          if (this.animationMixer && animName) {
            console.log(
              `Attempting to play ${animName} animation for ${this.modelName}`
            );
            this.animationMixer.playAnimation(animName);
          }
        },
      });
    </script>
  </head>

  <body style="margin: 0; overflow: hidden">
    <a-scene embedded arjs="debugUIEnabled: false;">
      <!-- Assets -->
      <a-assets>
        <!-- Models -->
        <a-asset-item id="whaleModel" src="models/whale.glb"></a-asset-item>
        <a-asset-item id="eagleModel" src="models/eagel.glb"></a-asset-item>

        <!-- Sounds -->
        <audio id="whaleSound" src="sounds/whale.mp3" preload="auto"></audio>
        <audio id="eagleSound" src="sounds/eagle.mp3" preload="auto"></audio>
      </a-assets>

      <!-- whale -->
      <a-marker type="pattern" url="markers/whale.patt">
        <a-entity
          gltf-model="#whaleModel"
          scale="0.5 0.5 0.5"
          position="0 0 0"
          gesture-detector
          rotation-reader
          animation-mixer="loop: repeat; timeScale: 1"
          model-animation-controller="animationName: whale; autoPlay: true"
        ></a-entity>
        <a-entity id="whaleSoundEntity" sound="src: #whaleSound"></a-entity>
      </a-marker>

      <!-- eagle -->
      <a-marker type="pattern" url="markers/eagle.patt">
        <a-entity
          gltf-model="#eagleModel"
          scale="0.4 0.4 0.4"
          position="0 0 0"
          gesture-detector
          rotation-reader
          animation-mixer="loop: repeat; timeScale: 1; clampWhenFinished: true"
          model-animation-controller="animationName: eagle; autoPlay: true"
        ></a-entity>
        <a-entity id="eagleSoundEntity" sound="src: #eagleSound"></a-entity>
      </a-marker>

      <!-- Camera -->
      <a-entity camera></a-entity>
    </a-scene>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize audio system on first user interaction
        document.body.addEventListener("click", () => {
          document.querySelectorAll("audio").forEach((audio) => {
            audio
              .play()
              .then(() => {
                audio.pause();
                audio.currentTime = 0;
              })
              .catch(() => {
                console.log("User interaction needed for sound");
              });
          });
        });

        // Map markers to their sound entities
        const markerMap = {
          "whale.patt": "whaleSoundEntity",
          "eagle.patt": "eagleSoundEntity",
        };

        // Handle marker detection and events
        document.querySelectorAll("a-marker").forEach((marker) => {
          // Play sound when marker is found
          marker.addEventListener("markerFound", () => {
            const url = marker.getAttribute("url");
            const fileName = url.split("/").pop();
            const soundEntityId = markerMap[fileName];
            const soundEntity = document.getElementById(soundEntityId);

            if (soundEntity && soundEntity.components.sound) {
              soundEntity.components.sound.playSound();
            }

            // Get model entity when marker is found
            const modelEntity = marker.querySelector("[animation-mixer]");
            if (modelEntity) {
              // Store reference to animation controller
              const modelController =
                modelEntity.components["model-animation-controller"];

              if (modelController) {
                // You can play specific animations by name if they exist
                // For example, if you know your eagle has a "fly" animation:
                // if (fileName === "eagle.patt") {
                //   modelController.playAnimation("fly");
                // }
                // Or for the whale:
                // if (fileName === "whale.patt") {
                //   modelController.playAnimation("swim");
                // }
              }
            }
          });

          // Handle marker lost event
          marker.addEventListener("markerLost", () => {
            const url = marker.getAttribute("url");
            const fileName = url.split("/").pop();
            const modelEntity = marker.querySelector("[animation-mixer]");

            if (modelEntity && modelEntity.components["animation-mixer"]) {
              // Optionally pause animations when marker is lost
              // Uncomment this if you want animations to pause when marker disappears
              // modelEntity.components["animation-mixer"].pauseAll();

              console.log(`Marker lost: ${fileName}`);
            }
          });
        });

        // Log when scene is ready
        const scene = document.querySelector("a-scene");
        scene.addEventListener("loaded", function () {
          console.log("AR scene fully loaded");
        });
      });
    </script>
  </body>
</html>
